import mysql.connector
from collections import Counter

# Declare the database and table names.
DB_NAME = "SiPbxDomain"
TABLE_NAME = "subscriber_config"  # "subscriber_config" for users, "dialplan_config" for dial translation rules, "registrar_config" for devices, etc


def fetch_table_data(conn):
    cursor = conn.cursor(dictionary=True)
    query = f"SELECT * FROM {TABLE_NAME}"
    cursor.execute(query)
    rows = cursor.fetchall()
    cursor.close()
    return rows


def normalize_value(value):
    """
    Convert None to an empty string and strip whitespace from string values.
    """
    if value is None:
        return ""
    return str(value).strip()


def row_to_string(row):
    """
    Convert a row (dictionary) to a canonical string representation.
    Sorting the keys ensures the same order on both hosts.
    """
    return "|".join(normalize_value(row[col]) for col in sorted(row.keys()))


def compare_data(valid_data, test_data):
    """
    Compare data from the valid (host1) database to the test (host2) database.
    Returns a list of differences and a total error count.
    """
    counter_valid = Counter(row_to_string(row) for row in valid_data)
    counter_test = Counter(row_to_string(row) for row in test_data)

    diff_output = []
    error_count = 0
    # Get all unique row representations from both counters.
    all_keys = set(counter_valid.keys()).union(set(counter_test.keys()))

    for key in all_keys:
        count_valid = counter_valid.get(key, 0)
        count_test = counter_test.get(key, 0)
        if count_valid != count_test:
            diff_output.append(
                f"Row: {key}\n  Count in valid DB (host1): {count_valid}\n  Count in test DB (host2): {count_test}"
            )
            error_count += abs(count_valid - count_test)

    return diff_output, error_count


def main():
    print("Enter VALID DB (host1) connection details:")
    valid_db_config = {
        "host": input("  Host: "),
        "user": input("  User: "),
        "password": input("  Password: "),
        "database": DB_NAME,
    }

    print("\nEnter TEST DB (host2) connection details:")
    test_db_config = {
        "host": input("  Host: "),
        "user": input("  User: "),
        "password": input("  Password: "),
        "database": DB_NAME,
    }

    try:
        valid_conn = mysql.connector.connect(**valid_db_config)
        test_conn = mysql.connector.connect(**test_db_config)
    except mysql.connector.Error as err:
        print("Error connecting to databases:", err)
        return

    print(
        f"\nComparing table '{TABLE_NAME}' in database '{DB_NAME}' between valid DB (host1) and test DB (host2)."
    )

    valid_data = fetch_table_data(valid_conn)
    test_data = fetch_table_data(test_conn)

    diffs, error_count = compare_data(valid_data, test_data)
    if diffs:
        print("\nDifferences found:")
        for diff in diffs:
            print(diff)
    else:
        print("\nNo differences found.")

    print(f"\nTotal entries missing/wrong in test DB (host2): {error_count}")

    valid_conn.close()
    test_conn.close()


if __name__ == "__main__":
    main()
